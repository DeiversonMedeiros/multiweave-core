 CREATE OR REPLACE FUNCTION rh.recalculate_time_record_hours(p_time_record_id uuid)                                                                                                                             +
  RETURNS void                                                                                                                                                                                                  +
  LANGUAGE plpgsql                                                                                                                                                                                              +
 AS $function$\r                                                                                                                                                                                                +
 DECLARE\r                                                                                                                                                                                                      +
   v_employee_id UUID;\r                                                                                                                                                                                        +
   v_company_id UUID;\r                                                                                                                                                                                         +
   v_date DATE;\r                                                                                                                                                                                               +
   v_horas_faltas numeric(4,2);\r                                                                                                                                                                               +
   v_entrada TIME;\r                                                                                                                                                                                            +
   v_saida TIME;\r                                                                                                                                                                                              +
   v_entrada_almoco TIME;\r                                                                                                                                                                                     +
   v_saida_almoco TIME;\r                                                                                                                                                                                       +
   v_entrada_extra1 TIME;\r                                                                                                                                                                                     +
   v_saida_extra1 TIME;\r                                                                                                                                                                                       +
   v_horas_trabalhadas numeric(4,2);\r                                                                                                                                                                          +
   v_horas_diarias numeric(4,2);\r                                                                                                                                                                              +
   v_horas_extra_window numeric(4,2) := 0;\r                                                                                                                                                                    +
   v_diferenca_horas numeric(4,2);\r                                                                                                                                                                            +
   v_requer_registro_ponto boolean := true;\r                                                                                                                                                                   +
   v_day_of_week INTEGER;\r                                                                                                                                                                                     +
   v_day_hours JSONB;\r                                                                                                                                                                                         +
   v_timezone text := 'America/Sao_Paulo';\r                                                                                                                                                                    +
   v_entrada_date_use date;\r                                                                                                                                                                                   +
   v_saida_date_use date;\r                                                                                                                                                                                     +
   v_entrada_almoco_date_use date;\r                                                                                                                                                                            +
   v_saida_almoco_date_use date;\r                                                                                                                                                                              +
   v_entrada_extra1_date_use date;\r                                                                                                                                                                            +
   v_saida_extra1_date_use date;\r                                                                                                                                                                              +
   v_entrada_event_at timestamptz;\r                                                                                                                                                                            +
   v_saida_event_at timestamptz;\r                                                                                                                                                                              +
   v_entrada_almoco_event_at timestamptz;\r                                                                                                                                                                     +
   v_saida_almoco_event_at timestamptz;\r                                                                                                                                                                       +
   v_entrada_extra1_event_at timestamptz;\r                                                                                                                                                                     +
   v_saida_extra1_event_at timestamptz;\r                                                                                                                                                                       +
   v_entrada_date date;\r                                                                                                                                                                                       +
   v_saida_date date;\r                                                                                                                                                                                         +
   v_entrada_almoco_date date;\r                                                                                                                                                                                +
   v_saida_almoco_date date;\r                                                                                                                                                                                  +
   v_entrada_extra1_date date;\r                                                                                                                                                                                +
   v_saida_extra1_date date;\r                                                                                                                                                                                  +
   v_entrada_date_for_night date;\r                                                                                                                                                                             +
   v_saida_date_for_night date;\r                                                                                                                                                                               +
   v_horas_noturnas numeric(4,2) := 0;\r                                                                                                                                                                        +
   v_work_shift_id UUID;\r                                                                                                                                                                                      +
   v_tipo_escala VARCHAR(50);\r                                                                                                                                                                                 +
 BEGIN\r                                                                                                                                                                                                        +
   SELECT tr.employee_id, tr.company_id, tr.data_registro, tr.horas_faltas,\r                                                                                                                                   +
          COALESCE(e.requer_registro_ponto, true)\r                                                                                                                                                             +
   INTO v_employee_id, v_company_id, v_date, v_horas_faltas, v_requer_registro_ponto\r                                                                                                                          +
   FROM rh.time_records tr\r                                                                                                                                                                                    +
   INNER JOIN rh.employees e ON e.id = tr.employee_id\r                                                                                                                                                         +
   WHERE tr.id = p_time_record_id;\r                                                                                                                                                                            +
 \r                                                                                                                                                                                                             +
   IF NOT FOUND THEN\r                                                                                                                                                                                          +
     RETURN;\r                                                                                                                                                                                                  +
   END IF;\r                                                                                                                                                                                                    +
 \r                                                                                                                                                                                                             +
   v_day_of_week := CASE \r                                                                                                                                                                                     +
     WHEN EXTRACT(DOW FROM v_date) = 0 THEN 7\r                                                                                                                                                                 +
     ELSE EXTRACT(DOW FROM v_date)::INTEGER\r                                                                                                                                                                   +
   END;\r                                                                                                                                                                                                       +
 \r                                                                                                                                                                                                             +
   SELECT \r                                                                                                                                                                                                    +
     rh.get_employee_work_shift_type(v_employee_id, v_company_id, v_date),\r                                                                                                                                    +
     es.turno_id,\r                                                                                                                                                                                             +
     ws.horas_diarias\r                                                                                                                                                                                         +
   INTO \r                                                                                                                                                                                                      +
     v_tipo_escala,\r                                                                                                                                                                                           +
     v_work_shift_id,\r                                                                                                                                                                                         +
     v_horas_diarias\r                                                                                                                                                                                          +
   FROM rh.employee_shifts es\r                                                                                                                                                                                 +
   INNER JOIN rh.work_shifts ws ON ws.id = es.turno_id\r                                                                                                                                                        +
   WHERE es.funcionario_id = v_employee_id\r                                                                                                                                                                    +
     AND es.company_id = v_company_id\r                                                                                                                                                                         +
     AND es.ativo = true\r                                                                                                                                                                                      +
     AND es.data_inicio <= v_date\r                                                                                                                                                                             +
     AND (es.data_fim IS NULL OR es.data_fim >= v_date)\r                                                                                                                                                       +
   ORDER BY es.data_inicio DESC\r                                                                                                                                                                               +
   LIMIT 1;\r                                                                                                                                                                                                   +
 \r                                                                                                                                                                                                             +
   IF v_work_shift_id IS NULL OR v_horas_diarias IS NULL THEN\r                                                                                                                                                 +
     SELECT \r                                                                                                                                                                                                  +
       rh.get_employee_work_shift_type(v_employee_id, v_company_id, v_date),\r                                                                                                                                  +
       e.work_shift_id,\r                                                                                                                                                                                       +
       ws.horas_diarias\r                                                                                                                                                                                       +
     INTO \r                                                                                                                                                                                                    +
       v_tipo_escala,\r                                                                                                                                                                                         +
       v_work_shift_id,\r                                                                                                                                                                                       +
       v_horas_diarias\r                                                                                                                                                                                        +
     FROM rh.employees e\r                                                                                                                                                                                      +
     LEFT JOIN rh.work_shifts ws ON ws.id = e.work_shift_id\r                                                                                                                                                   +
     WHERE e.id = v_employee_id\r                                                                                                                                                                               +
       AND e.company_id = v_company_id;\r                                                                                                                                                                       +
   END IF;\r                                                                                                                                                                                                    +
 \r                                                                                                                                                                                                             +
   IF v_work_shift_id IS NOT NULL THEN\r                                                                                                                                                                        +
     v_day_hours := rh.get_work_shift_hours_for_day(v_work_shift_id, v_day_of_week);\r                                                                                                                          +
     IF v_day_hours IS NOT NULL AND v_day_hours ? 'horas_diarias' THEN\r                                                                                                                                        +
       v_horas_diarias := COALESCE((v_day_hours->>'horas_diarias')::NUMERIC, v_horas_diarias);\r                                                                                                                +
     END IF;\r                                                                                                                                                                                                  +
   END IF;\r                                                                                                                                                                                                    +
 \r                                                                                                                                                                                                             +
   IF v_horas_diarias IS NULL AND v_work_shift_id IS NOT NULL THEN\r                                                                                                                                            +
     SELECT horas_diarias INTO v_horas_diarias FROM rh.work_shifts WHERE id = v_work_shift_id;\r                                                                                                                +
   END IF;\r                                                                                                                                                                                                    +
 \r                                                                                                                                                                                                             +
   IF v_horas_diarias IS NULL THEN\r                                                                                                                                                                            +
     v_horas_diarias := 8.0;\r                                                                                                                                                                                  +
   END IF;\r                                                                                                                                                                                                    +
 \r                                                                                                                                                                                                             +
   SELECT MIN(event_at) INTO v_entrada_event_at FROM rh.time_record_events WHERE time_record_id = p_time_record_id AND event_type = 'entrada';\r                                                                +
   SELECT MAX(event_at) INTO v_saida_event_at FROM rh.time_record_events WHERE time_record_id = p_time_record_id AND event_type = 'saida';\r                                                                    +
   SELECT MIN(event_at) INTO v_entrada_almoco_event_at FROM rh.time_record_events WHERE time_record_id = p_time_record_id AND event_type = 'entrada_almoco';\r                                                  +
   SELECT MAX(event_at) INTO v_saida_almoco_event_at FROM rh.time_record_events WHERE time_record_id = p_time_record_id AND event_type = 'saida_almoco';\r                                                      +
   SELECT MIN(event_at) INTO v_entrada_extra1_event_at FROM rh.time_record_events WHERE time_record_id = p_time_record_id AND event_type = 'extra_inicio';\r                                                    +
   SELECT MAX(event_at) INTO v_saida_extra1_event_at FROM rh.time_record_events WHERE time_record_id = p_time_record_id AND event_type = 'extra_fim';\r                                                         +
 \r                                                                                                                                                                                                             +
   IF v_entrada_event_at IS NOT NULL THEN v_entrada_date := (v_entrada_event_at AT TIME ZONE v_timezone)::date; END IF;\r                                                                                       +
   IF v_saida_event_at IS NOT NULL THEN v_saida_date := (v_saida_event_at AT TIME ZONE v_timezone)::date; END IF;\r                                                                                             +
   IF v_entrada_almoco_event_at IS NOT NULL THEN v_entrada_almoco_date := (v_entrada_almoco_event_at AT TIME ZONE v_timezone)::date; END IF;\r                                                                  +
   IF v_saida_almoco_event_at IS NOT NULL THEN v_saida_almoco_date := (v_saida_almoco_event_at AT TIME ZONE v_timezone)::date; END IF;\r                                                                        +
   IF v_entrada_extra1_event_at IS NOT NULL THEN v_entrada_extra1_date := (v_entrada_extra1_event_at AT TIME ZONE v_timezone)::date; END IF;\r                                                                  +
   IF v_saida_extra1_event_at IS NOT NULL THEN v_saida_extra1_date := (v_saida_extra1_event_at AT TIME ZONE v_timezone)::date; END IF;\r                                                                        +
 \r                                                                                                                                                                                                             +
   IF v_entrada_event_at IS NOT NULL THEN\r                                                                                                                                                                     +
     SELECT (event_at AT TIME ZONE v_timezone)::time INTO v_entrada FROM rh.time_record_events WHERE time_record_id = p_time_record_id AND event_type = 'entrada' ORDER BY event_at ASC LIMIT 1;\r              +
   END IF;\r                                                                                                                                                                                                    +
   IF v_saida_event_at IS NOT NULL THEN\r                                                                                                                                                                       +
     SELECT (event_at AT TIME ZONE v_timezone)::time INTO v_saida FROM rh.time_record_events WHERE time_record_id = p_time_record_id AND event_type = 'saida' ORDER BY event_at DESC LIMIT 1;\r                 +
   END IF;\r                                                                                                                                                                                                    +
   IF v_entrada_almoco_event_at IS NOT NULL THEN\r                                                                                                                                                              +
     SELECT (event_at AT TIME ZONE v_timezone)::time INTO v_entrada_almoco FROM rh.time_record_events WHERE time_record_id = p_time_record_id AND event_type = 'entrada_almoco' ORDER BY event_at ASC LIMIT 1;\r+
   END IF;\r                                                                                                                                                                                                    +
   IF v_saida_almoco_event_at IS NOT NULL THEN\r                                                                                                                                                                +
     SELECT (event_at AT TIME ZONE v_timezone)::time INTO v_saida_almoco FROM rh.time_record_events WHERE time_record_id = p_time_record_id AND event_type = 'saida_almoco' ORDER BY event_at DESC LIMIT 1;\r   +
   END IF;\r                                                                                                                                                                                                    +
   IF v_entrada_extra1_event_at IS NOT NULL THEN\r                                                                                                                                                              +
     SELECT (event_at AT TIME ZONE v_timezone)::time INTO v_entrada_extra1 FROM rh.time_record_events WHERE time_record_id = p_time_record_id AND event_type = 'extra_inicio' ORDER BY event_at ASC LIMIT 1;\r  +
   END IF;\r                                                                                                                                                                                                    +
   IF v_saida_extra1_event_at IS NOT NULL THEN\r                                                                                                                                                                +
     SELECT (event_at AT TIME ZONE v_timezone)::time INTO v_saida_extra1 FROM rh.time_record_events WHERE time_record_id = p_time_record_id AND event_type = 'extra_fim' ORDER BY event_at DESC LIMIT 1;\r      +
   END IF;\r                                                                                                                                                                                                    +
 \r                                                                                                                                                                                                             +
   IF v_entrada IS NULL OR v_saida IS NULL THEN\r                                                                                                                                                               +
     SELECT entrada, saida, entrada_almoco, saida_almoco, entrada_extra1, saida_extra1\r                                                                                                                        +
     INTO v_entrada, v_saida, v_entrada_almoco, v_saida_almoco, v_entrada_extra1, v_saida_extra1\r                                                                                                              +
     FROM rh.time_records WHERE id = p_time_record_id;\r                                                                                                                                                        +
   END IF;\r                                                                                                                                                                                                    +
 \r                                                                                                                                                                                                             +
   IF v_entrada_event_at IS NOT NULL AND v_saida_event_at IS NOT NULL THEN\r                                                                                                                                    +
     v_horas_trabalhadas := ROUND(EXTRACT(EPOCH FROM (v_saida_event_at - v_entrada_event_at)) / 3600, 2);\r                                                                                                     +
     IF v_entrada_almoco_event_at IS NOT NULL AND v_saida_almoco_event_at IS NOT NULL THEN\r                                                                                                                    +
       v_horas_trabalhadas := v_horas_trabalhadas - ROUND(EXTRACT(EPOCH FROM (v_saida_almoco_event_at - v_entrada_almoco_event_at)) / 3600, 2);\r                                                               +
     END IF;\r                                                                                                                                                                                                  +
     IF v_entrada_extra1_event_at IS NOT NULL AND v_saida_extra1_event_at IS NOT NULL THEN\r                                                                                                                    +
       v_horas_trabalhadas := v_horas_trabalhadas + ROUND(EXTRACT(EPOCH FROM (v_saida_extra1_event_at - v_entrada_extra1_event_at)) / 3600, 2);\r                                                               +
     END IF;\r                                                                                                                                                                                                  +
   ELSIF v_entrada_date IS NOT NULL AND v_saida_date IS NOT NULL AND v_entrada IS NOT NULL AND v_saida IS NOT NULL THEN\r                                                                                       +
     v_entrada_date_use := v_entrada_date;\r                                                                                                                                                                    +
     v_saida_date_use := v_saida_date;\r                                                                                                                                                                        +
     v_horas_trabalhadas := ROUND(EXTRACT(EPOCH FROM ((v_saida_date_use + v_saida)::timestamp - (v_entrada_date_use + v_entrada)::timestamp)) 

